<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¨åŠ›å½©é¸è™Ÿå™¨ï¼ˆSheetè³‡æ–™åº« + è‡ªå‹•æ›´æ–° + é »ç‡/åˆ†å¸ƒ + åŠ æ¬Šè’™åœ°å¡ç¾…ï¼‰</title>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Chart.js time scale adapter (date-fns) -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    :root { --bg:#0b1220; --card:#111a2e; --muted:#9fb0d0; --text:#eaf0ff; --line:#233457; --accent:#76a7ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
           background: linear-gradient(180deg, #0b1220 0%, #090f1c 100%); color: var(--text); }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 18px; }
    .top { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .title { display:flex; flex-direction:column; gap:4px; }
    h1 { margin:0; font-size: 18px; letter-spacing: .5px; }
    .sub { color: var(--muted); font-size: 13px; }
    .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top: 12px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card { background: rgba(17,26,46,.92); border: 1px solid rgba(35,52,87,.9);
            border-radius: 14px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin: 0 0 10px; font-size: 14px; color: #dbe6ff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 0 0 auto; }
    label { font-size: 13px; color: var(--muted); }
    input, select, button {
      background: rgba(9,15,28,.8); color: var(--text);
      border: 1px solid rgba(35,52,87,.9); border-radius: 10px;
      padding: 9px 10px; font-size: 13px;
    }
    input[type="range"] { padding: 0; height: 28px; }
    button { cursor:pointer; }
    button.primary { border-color: rgba(118,167,255,.9); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 999px;
            border: 1px solid rgba(35,52,87,.9); background: rgba(9,15,28,.55); font-size: 13px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .kpi .pill { color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .charts2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px) { .charts2 { grid-template-columns: 1fr; } }

    .numbers { display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
    .ball { width: 34px; height: 34px; border-radius: 999px; display:flex; align-items:center; justify-content:center;
            border: 1px solid rgba(35,52,87,.9); background: rgba(9,15,28,.65); font-weight: 650; }
    .ball.s { border-color: rgba(255,210,120,.75); }
    .out { white-space: pre-wrap; line-height: 1.45; color: #dbe6ff; margin-top: 10px; font-size: 13px; }
    .muted { color: var(--muted); }
    .hr { height:1px; background: rgba(35,52,87,.9); margin: 12px 0; }
    .small { font-size: 12px; color: var(--muted); }
    details summary { cursor:pointer; }

    .statusline { margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .dot { width:10px; height:10px; border-radius:999px; background:#4ade80; display:inline-block; }
    .dot.bad { background:#fb7185; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title">
      <h1>å¨åŠ›å½©é¸è™Ÿå™¨ï¼ˆSheetè³‡æ–™åº« + è‡ªå‹•æ›´æ–° + è¿‘5å¹´é »ç‡/åˆ†å¸ƒ + åŠ æ¬Šè’™åœ°å¡ç¾…ï¼‰</h1>
      <div class="sub">
        å†·è™Ÿå®šç¾©ï¼š<b>å‡ºç¾é »ç‡ä½</b>ï¼ˆAï¼‰ï½œç¬¬ä¸€å€ 1â€“38 æŠ½ 6ã€ä¸é‡è¤‡ï¼›ç¬¬äºŒå€ 1â€“8 æŠ½ 1ï½œ
        <span class="mono">è³‡æ–™ä¾†æºï¼šä½ çš„ Google Sheetï¼ˆç”± GAS ç¶­è­·ï¼‰</span>
      </div>
    </div>
    <div class="row">
      <button class="primary" id="btnReload">é‡æ–°è¼‰å…¥ï¼ˆå¾ Sheetï¼‰</button>
      <button class="primary" id="btnFetchLatest">è‡ªå‹•æŠ“æœ€æ–°ä¸€æœŸä¸¦è¿½åŠ ï¼ˆå¯«å…¥ Sheetï¼‰</button>
    </div>
  </div>

  <div class="kpi">
    <div class="pill">è³‡æ–™ç­†æ•¸ï¼š<span id="kpiRows" class="mono">-</span></div>
    <div class="pill">è³‡æ–™å€é–“ï¼š<span id="kpiRange" class="mono">-</span></div>
    <div class="pill">æœ€æ–°æœŸåˆ¥ï¼š<span id="kpiLatest" class="mono">-</span></div>
    <div class="pill">å¾Œç«¯ï¼š<span class="mono">GAS Web App + Google Sheet</span></div>
  </div>

  <div class="statusline">
    <span id="connDot" class="dot bad"></span>
    <span class="small muted">é€£ç·šç‹€æ…‹ï¼š</span>
    <span id="connText" class="small mono">å°šæœªé€£ç·š</span>
  </div>

  <div class="grid">
    <div class="card">
      <h2>é »ç‡åœ–ï¼ˆè¿‘ 5 å¹´ / ä»¥ä½  Sheet å…§è³‡æ–™ç‚ºæº–ï¼‰</h2>
      <div class="charts2">
        <div class="card" style="padding:10px;">
          <div class="muted small">ç¬¬ä¸€å€ 1â€“38 å‡ºç¾æ¬¡æ•¸</div>
          <canvas id="chartMain"></canvas>
        </div>
        <div class="card" style="padding:10px;">
          <div class="muted small">ç¬¬äºŒå€ 1â€“8 å‡ºç¾æ¬¡æ•¸</div>
          <canvas id="chartSecond"></canvas>
        </div>
      </div>

      <div class="hr"></div>

      <h2>æ™‚é–“åˆ†å¸ƒï¼ˆé¸ä¸€å€‹è™Ÿç¢¼çœ‹ã€Œæ¯æ¬¡å‡ºç¾çš„æ—¥æœŸã€ï¼‰</h2>
      <div class="row">
        <label>å€åŸŸ
          <select id="selZone">
            <option value="main">ç¬¬ä¸€å€ï¼ˆ1â€“38ï¼‰</option>
            <option value="second">ç¬¬äºŒå€ï¼ˆ1â€“8ï¼‰</option>
          </select>
        </label>
        <label>è™Ÿç¢¼
          <select id="selNumber"></select>
        </label>
      </div>
      <div class="card" style="padding:10px; margin-top:10px;">
        <div class="muted small">æ•£é»ï¼è©²è™Ÿç¢¼å‡ºç¾çš„æ¯ä¸€æœŸï¼ˆy è»¸å›ºå®š 1 åªæ˜¯æ–¹ä¾¿ç•«ï¼‰</div>
        <canvas id="chartTimeline"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>åŠ æ¬Šé¸è™Ÿï¼ˆè’™åœ°å¡ç¾…æŠ½æ¨£å™¨ï¼‰</h2>

      <div class="row" style="margin-bottom:10px;">
        <label>æ¬Šé‡æ¨¡å¼
          <select id="selMode">
            <option value="hot">ç†±è™ŸåŠ æ¬Šï¼ˆé »ç‡é«˜ â†’ æ¬Šé‡é«˜ï¼‰</option>
            <option value="cold">å†·è™ŸåŠ æ¬Šï¼ˆé »ç‡ä½ â†’ æ¬Šé‡é«˜ï¼‰</option>
            <option value="mix">æ··åˆï¼ˆå‡å‹» + ç†±/å†·ï¼Œå¯èª¿ Î±ï¼‰</option>
          </select>
        </label>

        <label id="mixBaseWrap" style="display:none;">æ··åˆåŸºåº•
          <select id="selMixBase">
            <option value="hot">ç†±è™Ÿ</option>
            <option value="cold">å†·è™Ÿï¼ˆä½é »ï¼‰</option>
          </select>
        </label>

        <label id="alphaWrap" style="display:none;">Î±ï¼ˆè¶Šå¤§è¶Šæ¥è¿‘å‡å‹»ï¼‰
          <input id="rngAlpha" type="range" min="0" max="1" step="0.01" value="0.35" />
          <span id="alphaVal" class="mono">0.35</span>
        </label>
      </div>

      <div class="row">
        <label>ç”¢ç”Ÿçµ„æ•¸
          <input id="inpN" type="number" min="1" max="50" value="5" style="width:90px;" />
        </label>
        <button class="primary" id="btnGen">ç”¢ç”Ÿè™Ÿç¢¼</button>
      </div>

      <div class="hr"></div>

      <div class="muted small">æœ¬æ¬¡ç”¢ç”Ÿï¼ˆç¬¬ä¸€å€æ’åºé¡¯ç¤ºï¼‰ï¼š</div>
      <div id="preview" class="numbers"></div>
      <div id="out" class="out"></div>

      <div class="hr"></div>

      <h2>è¿‘ 5 å¹´ ç†±/å†·è™Ÿ Top 10ï¼ˆç¬¬ä¸€å€ï¼‰</h2>
      <div id="top10Main" class="out"></div>

      <h2 style="margin-top:10px;">è·é›¢ä¸Šæ¬¡é–‹å‡ºï¼ˆgapï¼ŒæœŸæ•¸ï¼‰</h2>
      <div class="small muted">gapï¼å¾æœ€æ–°ä¸€æœŸå¾€å›æ•¸ï¼Œ0 ä»£è¡¨æœ€æ–°ä¸€æœŸå°±å‡ºç¾</div>
      <div id="gapMain" class="out"></div>

      <div class="hr"></div>

      <details>
        <summary class="small">å¾Œç«¯è¨­å®šï¼ˆGAS Web App URLï¼‰</summary>
        <div class="small muted" style="margin-top:8px;">
          ä½ åªéœ€è¦æ”¹ <span class="mono">GAS_BASE</span> ä¸€è¡Œã€‚åˆ¥äººæ‹¿åˆ° GitHub Pages é€£çµå¾Œï¼Œ<b>ä¸éœ€è¦åŒ¯å…¥ä»»ä½• CSV</b>ï¼Œè³‡æ–™æœƒç›´æ¥å¾ä½ çš„ Sheet è®€å–ã€‚
        </div>
        <div class="small muted" style="margin-top:10px;">
          GAS Web App URLï¼š<br/>
          <span class="mono" id="gasTxt"></span>
        </div>
        <div class="small muted" style="margin-top:8px;">
          æ¸¬è©¦ï¼ˆexportï¼‰ï¼š<br/>
          <span class="mono" id="gasTest"></span>
        </div>
      </details>

    </div>
  </div>
</div>

<script>
/** =========================
 *  ä½ åªéœ€è¦æ”¹é€™ä¸€è¡Œï¼
 *  æŠŠ GAS_BASE æ›æˆä½ éƒ¨ç½²å¾Œçš„ Web App /exec URL
 *  ä¾‹å¦‚ï¼šhttps://script.google.com/macros/s/XXXXX/exec
 *  ========================= */
const GAS_BASE = "https://script.google.com/macros/s/AKfycbxUsoAeLxDcvRFCkCJ44gKbY3oXr694KYX_mdlhno3OdekivzHsjqUI6a4C3wUEBMlr/exec"; // â† æ”¹é€™è£¡ï¼ˆä½ çš„ /execï¼‰

/** ========= Config ========= */
const MAIN_MAX = 38;
const SECOND_MAX = 8;

/** ========= State ========= */
let rows = []; // {draw_id, draw_date(Date), n:[6], s}
let chartMain, chartSecond, chartTimeline;

/** ========= Utilities ========= */
function pad2(n){ return String(n).padStart(2,"0"); }
function toISODate(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
  return `${y}-${m}-${da}`;
}
function parseDateFlexible(s){
  const t = (s||"").trim();
  if (!t) return null;

  // YYYY-MM-DD or YYYY/MM/DD
  let m = t.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
  if (m) return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));

  // ROC: "115 å¹´ 2 æœˆ 9 æ—¥" (no "æ°‘åœ‹" also accepted)
  m = t.match(/(\d{2,3})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
  if (m){
    const roc = Number(m[1]);
    const y = roc + 1911;
    return new Date(y, Number(m[2])-1, Number(m[3]));
  }

  const d = new Date(t);
  return isNaN(d.getTime()) ? null : d;
}

function uniqByDrawId(arr){
  const m = new Map();
  for (const r of arr){
    if (!m.has(r.draw_id)) m.set(r.draw_id, r);
  }
  return Array.from(m.values()).sort((a,b)=>a.draw_date-b.draw_date);
}

function lastNYears(arr, years=5){
  if (!arr.length) return [];
  const maxDate = arr[arr.length-1].draw_date;
  const start = new Date(maxDate);
  start.setFullYear(start.getFullYear() - years);
  return arr.filter(r=>r.draw_date >= start);
}

/** ========= Stats ========= */
function freqMain(data){
  const f = Array(MAIN_MAX+1).fill(0);
  for (const r of data) for (const x of r.n) f[x]++;
  return f;
}
function freqSecond(data){
  const f = Array(SECOND_MAX+1).fill(0);
  for (const r of data) f[r.s]++;
  return f;
}

function topKFromFreq(freqArr, k=10, mode="hot"){
  const items = [];
  for (let i=1;i<freqArr.length;i++){
    items.push({num:i, cnt: freqArr[i]});
  }
  items.sort((a,b)=>{
    if (mode==="hot"){
      if (b.cnt !== a.cnt) return b.cnt - a.cnt;
      return a.num - b.num;
    } else {
      if (a.cnt !== b.cnt) return a.cnt - b.cnt;
      return a.num - b.num;
    }
  });
  return items.slice(0,k);
}

function calcGapMain(data){
  const gap = Array(MAIN_MAX+1).fill(null);
  for (let back=0; back<data.length; back++){
    const r = data[data.length-1-back];
    for (const x of r.n){
      if (gap[x] === null) gap[x] = back;
    }
    let done = true;
    for (let i=1;i<=MAIN_MAX;i++){ if (gap[i] === null) { done=false; break; } }
    if (done) break;
  }
  return gap;
}

function renderTopAndGap(){
  if (!rows.length) return;

  const data5 = lastNYears(rows, 5);
  const fm = freqMain(data5);

  const hot10 = topKFromFreq(fm, 10, "hot");
  const cold10 = topKFromFreq(fm, 10, "cold");

  const fmtList = (arr)=>arr.map((x,i)=>`${String(i+1).padStart(2,"0")}. ${pad2(x.num)}ï¼ˆ${x.cnt}ï¼‰`).join("\n");

  const elTop = document.getElementById("top10Main");
  if (elTop){
    elTop.textContent =
      `ğŸ”¥ ç†±è™Ÿ Top10ï¼ˆæ¬¡æ•¸ï¼‰\n${fmtList(hot10)}\n\n` +
      `ğŸ§Š å†·è™Ÿ Top10ï¼ˆæ¬¡æ•¸ï¼‰\n${fmtList(cold10)}`;
  }

  const gap = calcGapMain(data5);
  const gapItems = [];
  for (let i=1;i<=MAIN_MAX;i++){
    gapItems.push({num:i, gap: gap[i]});
  }
  gapItems.sort((a,b)=>{
    const ga = (a.gap===null)? 1e9 : a.gap;
    const gb = (b.gap===null)? 1e9 : b.gap;
    if (gb !== ga) return gb - ga;
    return a.num - b.num;
  });

  const topGap = gapItems.slice(0, 15);
  const elGap = document.getElementById("gapMain");
  if (elGap){
    elGap.textContent =
      `â³ æœ€ä¹…æ²’å‡ºçš„å‰ 15ï¼ˆgap æœŸæ•¸ï¼‰\n` +
      topGap.map((x,i)=>{
        const g = (x.gap===null) ? "NA" : String(x.gap);
        return `${String(i+1).padStart(2,"0")}. ${pad2(x.num)}ï¼ˆgap=${g}ï¼‰`;
      }).join("\n");
  }
}

/** ========= Weighted sampling without replacement =========
 * Efraimidisâ€“Spirakis (A-ES): key = u^(1/w), pick top-k by key
 */
function weightedSampleWithoutReplacement(items, weights, k){
  const scored = items.map((it,i)=>{
    const w = Math.max(1e-9, weights[i]);
    const u = Math.random();
    const key = Math.pow(u, 1.0 / w);
    return {it, key};
  });
  scored.sort((a,b)=>b.key-a.key);
  return scored.slice(0,k).map(x=>x.it);
}

function buildWeights(mode, base, alpha, data){
  const fm = freqMain(data);
  const fs = freqSecond(data);

  const mainCount = fm.slice(1);
  const secCount  = fs.slice(1);

  const maxM = Math.max(...mainCount, 1);
  const maxS = Math.max(...secCount, 1);

  function hotW(counts){ return counts.map(c=>c); }
  function coldW(counts, maxC){ return counts.map(c=> (maxC - c + 1)); }

  let wm, ws;

  if (mode === "hot"){
    wm = hotW(mainCount); ws = hotW(secCount);
  } else if (mode === "cold"){
    wm = coldW(mainCount, maxM); ws = coldW(secCount, maxS);
  } else {
    const uniM = Array(MAIN_MAX).fill(1);
    const uniS = Array(SECOND_MAX).fill(1);
    const baseWm = (base==="cold") ? coldW(mainCount, maxM) : hotW(mainCount);
    const baseWs = (base==="cold") ? coldW(secCount, maxS) : hotW(secCount);

    wm = uniM.map((u,i)=> alpha*u + (1-alpha)*baseWm[i]);
    ws = uniS.map((u,i)=> alpha*u + (1-alpha)*baseWs[i]);
  }

  return {
    wm: wm.map(x=>Math.max(1e-6,x)),
    ws: ws.map(x=>Math.max(1e-6,x))
  };
}

/** ========= UI / Charts ========= */
function setKPI(){
  document.getElementById("kpiRows").textContent = rows.length ? String(rows.length) : "-";
  if (!rows.length){
    document.getElementById("kpiRange").textContent = "-";
    document.getElementById("kpiLatest").textContent = "-";
    return;
  }
  const minD = rows[0].draw_date, maxD = rows[rows.length-1].draw_date;
  document.getElementById("kpiRange").textContent = `${toISODate(minD)} ~ ${toISODate(maxD)}`;
  document.getElementById("kpiLatest").textContent = rows[rows.length-1].draw_id;
}

function rebuildNumberOptions(){
  const zone = document.getElementById("selZone").value;
  const sel = document.getElementById("selNumber");
  sel.innerHTML = "";
  const max = (zone==="main") ? MAIN_MAX : SECOND_MAX;
  for (let i=1;i<=max;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    sel.appendChild(opt);
  }
}

function renderTimeline(){
  if (!rows.length) return;
  const data5 = lastNYears(rows, 5);
  const zone = document.getElementById("selZone").value;
  const num = Number(document.getElementById("selNumber").value);

  const pts = [];
  for (const r of data5){
    const hit = (zone==="main") ? r.n.includes(num) : (r.s === num);
    if (hit){
      pts.push({ x: r.draw_date.getTime(), y: 1, draw_id: r.draw_id });
    }
  }

  const ctxT = document.getElementById("chartTimeline");
  if (chartTimeline) chartTimeline.destroy();

  chartTimeline = new Chart(ctxT, {
    type: 'scatter',
    data: { datasets: [{ label:"å‡ºç¾", data: pts, pointRadius: 4 }] },
    options: {
      responsive:true,
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const d = new Date(ctx.raw.x);
              return `${toISODate(d)} æœŸåˆ¥ ${ctx.raw.draw_id}`;
            }
          }
        }
      },
      scales:{
        x:{
          type:'time',
          time:{ unit:'month' },
          ticks:{ color:"#9fb0d0" },
          grid:{ color:"rgba(35,52,87,.35)" }
        },
        y:{
          min:0, max:2,
          ticks:{ display:false },
          grid:{ color:"rgba(35,52,87,.15)" }
        }
      }
    }
  });
}

function renderCharts(){
  if (!rows.length) return;
  const data5 = lastNYears(rows, 5);

  const fm = freqMain(data5);
  const fs = freqSecond(data5);

  const labelsM = Array.from({length:MAIN_MAX}, (_,i)=>String(i+1));
  const valuesM = fm.slice(1);

  const labelsS = Array.from({length:SECOND_MAX}, (_,i)=>String(i+1));
  const valuesS = fs.slice(1);

  const ctxM = document.getElementById("chartMain");
  const ctxS = document.getElementById("chartSecond");

  if (chartMain) chartMain.destroy();
  if (chartSecond) chartSecond.destroy();

  chartMain = new Chart(ctxM, {
    type: 'bar',
    data: { labels: labelsM, datasets: [{ label:"æ¬¡æ•¸", data: valuesM }] },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ enabled:true } },
      scales:{
        x:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } },
        y:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } }
      }
    }
  });

  chartSecond = new Chart(ctxS, {
    type: 'bar',
    data: { labels: labelsS, datasets: [{ label:"æ¬¡æ•¸", data: valuesS }] },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ enabled:true } },
      scales:{
        x:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } },
        y:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } }
      }
    }
  });

  rebuildNumberOptions();
  renderTimeline();
  renderTopAndGap();
}

/** ========= Generator ========= */
function genOne(mode, mixBase, alpha, data5){
  const {wm, ws} = buildWeights(mode, mixBase, alpha, data5);

  const mainItems = Array.from({length:MAIN_MAX}, (_,i)=>i+1);
  const secItems  = Array.from({length:SECOND_MAX}, (_,i)=>i+1);

  const pickedMain = weightedSampleWithoutReplacement(mainItems, wm, 6).sort((a,b)=>a-b);
  const pickedSec  = weightedSampleWithoutReplacement(secItems, ws, 1)[0];

  return { pickedMain, pickedSec };
}

function renderPreview(main, sec){
  const box = document.getElementById("preview");
  box.innerHTML = "";
  for (const x of main){
    const d = document.createElement("div");
    d.className = "ball";
    d.textContent = pad2(x);
    box.appendChild(d);
  }
  const s = document.createElement("div");
  s.className = "ball s";
  s.textContent = pad2(sec);
  box.appendChild(s);
}

/** ========= GAS calls ========= */
function gasActionUrl(action, extraQuery=""){
  const joiner = GAS_BASE.includes("?") ? "&" : "?";
  return `${GAS_BASE}${joiner}action=${encodeURIComponent(action)}${extraQuery ? "&"+extraQuery : ""}`;
}

async function gasGetJson(action, extraQuery=""){
  const url = gasActionUrl(action, extraQuery);
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const j = await res.json();
  if (!j.ok) throw new Error(j.error || "GAS error");
  return j;
}

async function loadRowsFromSheet(){
  const j = await gasGetJson("export");
  const data = j.data || [];

  // Convert sheet rows -> our rows format
  const parsed = [];
  for (const r of data){
    // r.draw_date might be "YYYY-MM-DD" or Date-like string
    const d = parseDateFlexible(String(r.draw_date || ""));
    if (!d) continue;

    const n = [
      Number(r.n1), Number(r.n2), Number(r.n3),
      Number(r.n4), Number(r.n5), Number(r.n6)
    ].filter(x=>Number.isFinite(x));

    const s = Number(r.s);

    if (!r.draw_id || n.length !== 6 || !Number.isFinite(s)) continue;
    parsed.push({ draw_id: String(r.draw_id), draw_date: d, n, s });
  }

  rows = uniqByDrawId(parsed);
  setKPI();
  renderCharts();
}

async function appendLatestAndRefresh(){
  const btn = document.getElementById("btnFetchLatest");
  btn.disabled = true;
  btn.textContent = "è¿½åŠ ä¸­â€¦";

  try{
    const j = await gasGetJson("append_latest");
    const inserted = !!j.inserted;
    await loadRowsFromSheet();
    alert(inserted ? "âœ… å·²è¿½åŠ æœ€æ–°ä¸€æœŸä¸¦åˆ·æ–°ï¼ˆå¯«å…¥ Sheetï¼‰" : "â„¹ï¸ Sheet å·²åŒ…å«æœ€æ–°ä¸€æœŸï¼ˆä»å·²åˆ·æ–°ï¼‰");
  } catch(e){
    console.error(e);
    alert(`âŒ è¿½åŠ å¤±æ•—ï¼š${e.message}`);
  } finally {
    btn.disabled = false;
    btn.textContent = "è‡ªå‹•æŠ“æœ€æ–°ä¸€æœŸä¸¦è¿½åŠ ï¼ˆå¯«å…¥ Sheetï¼‰";
  }
}

/** ========= Connection indicator ========= */
function setConn(ok, txt){
  const dot = document.getElementById("connDot");
  const el = document.getElementById("connText");
  dot.classList.toggle("bad", !ok);
  el.textContent = txt;
}

/** ========= Wire up ========= */
document.getElementById("selZone").addEventListener("change", ()=>{
  rebuildNumberOptions();
  renderTimeline();
});
document.getElementById("selNumber").addEventListener("change", renderTimeline);

document.getElementById("selMode").addEventListener("change", ()=>{
  const mode = document.getElementById("selMode").value;
  const showMix = (mode === "mix");
  document.getElementById("alphaWrap").style.display = showMix ? "" : "none";
  document.getElementById("mixBaseWrap").style.display = showMix ? "" : "none";
});

document.getElementById("rngAlpha").addEventListener("input", (e)=>{
  document.getElementById("alphaVal").textContent = Number(e.target.value).toFixed(2);
});

document.getElementById("btnGen").addEventListener("click", ()=>{
  if (!rows.length){
    alert("è³‡æ–™å°šæœªè¼‰å…¥ã€‚è«‹å…ˆæŒ‰ã€Œé‡æ–°è¼‰å…¥ï¼ˆå¾ Sheetï¼‰ã€æˆ–ç¨å€™åˆå§‹åŒ–å®Œæˆã€‚");
    return;
  }
  const data5 = lastNYears(rows, 5);
  if (!data5.length){
    alert("è¿‘ 5 å¹´è³‡æ–™ç‚ºç©ºï¼ˆæˆ–æ—¥æœŸè§£æå¤±æ•—ï¼‰ã€‚");
    return;
  }

  const mode = document.getElementById("selMode").value;
  const mixBase = document.getElementById("selMixBase").value;
  const alpha = Number(document.getElementById("rngAlpha").value);
  const N = Math.max(1, Math.min(50, Number(document.getElementById("inpN").value || 5)));

  const lines = [];
  for (let i=0;i<N;i++){
    const {pickedMain, pickedSec} = genOne(mode, mixBase, alpha, data5);
    lines.push(`${String(i+1).padStart(2,"0")}. ${pickedMain.map(pad2).join(" ")}  +  ${pad2(pickedSec)}`);
    if (i===0) renderPreview(pickedMain, pickedSec);
  }
  document.getElementById("out").textContent = lines.join("\n");
});

document.getElementById("btnFetchLatest").addEventListener("click", appendLatestAndRefresh);

document.getElementById("btnReload").addEventListener("click", async ()=>{
  const btn = document.getElementById("btnReload");
  btn.disabled = true;
  btn.textContent = "è¼‰å…¥ä¸­â€¦";
  try{
    await loadRowsFromSheet();
    setConn(true, "å·²é€£ç·šï¼ˆexport æˆåŠŸï¼‰");
  } catch(e){
    console.error(e);
    setConn(false, "é€£ç·šå¤±æ•—ï¼ˆè«‹æª¢æŸ¥ GAS_BASEï¼‰");
    alert(`è¼‰å…¥å¤±æ•—ï¼š${e.message}`);
  } finally {
    btn.disabled = false;
    btn.textContent = "é‡æ–°è¼‰å…¥ï¼ˆå¾ Sheetï¼‰";
  }
});

/** ========= Boot ========= */
(function init(){
  document.getElementById("alphaVal").textContent = Number(document.getElementById("rngAlpha").value).toFixed(2);

  // show backend info
  document.getElementById("gasTxt").textContent = GAS_BASE;
  document.getElementById("gasTest").textContent = gasActionUrl("export");

  // auto load once
  (async ()=>{
    try{
      await loadRowsFromSheet();
      setConn(true, "å·²é€£ç·šï¼ˆexport æˆåŠŸï¼‰");
    } catch(e){
      console.error(e);
      setConn(false, "é€£ç·šå¤±æ•—ï¼ˆè«‹æª¢æŸ¥ GAS_BASE æ˜¯å¦ç‚º /execï¼‰");
    }
  })();
})();
</script>
</body>
</html>

