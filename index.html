<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¨åŠ›å½©é¸è™Ÿå™¨ï¼ˆé »ç‡/åˆ†å¸ƒ + åŠ æ¬Šè’™åœ°å¡ç¾… + GAS Proxy è‡ªå‹•æ›´æ–°ï¼‰</title>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Chart.js time scale adapter (date-fns) -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    :root { --bg:#0b1220; --card:#111a2e; --muted:#9fb0d0; --text:#eaf0ff; --line:#233457; --accent:#76a7ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
           background: linear-gradient(180deg, #0b1220 0%, #090f1c 100%); color: var(--text); }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 18px; }
    .top { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .title { display:flex; flex-direction:column; gap:4px; }
    h1 { margin:0; font-size: 18px; letter-spacing: .5px; }
    .sub { color: var(--muted); font-size: 13px; }
    .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top: 12px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card { background: rgba(17,26,46,.92); border: 1px solid rgba(35,52,87,.9);
            border-radius: 14px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin: 0 0 10px; font-size: 14px; color: #dbe6ff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 0 0 auto; }
    label { font-size: 13px; color: var(--muted); }
    input, select, button, textarea {
      background: rgba(9,15,28,.8); color: var(--text);
      border: 1px solid rgba(35,52,87,.9); border-radius: 10px;
      padding: 9px 10px; font-size: 13px;
    }
    input[type="range"] { padding: 0; height: 28px; }
    button { cursor:pointer; }
    button.primary { border-color: rgba(118,167,255,.9); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 999px;
            border: 1px solid rgba(35,52,87,.9); background: rgba(9,15,28,.55); font-size: 13px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .kpi .pill { color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .charts2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px) { .charts2 { grid-template-columns: 1fr; } }

    .numbers { display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
    .ball { width: 34px; height: 34px; border-radius: 999px; display:flex; align-items:center; justify-content:center;
            border: 1px solid rgba(35,52,87,.9); background: rgba(9,15,28,.65); font-weight: 650; }
    .ball.s { border-color: rgba(255,210,120,.75); }
    .out { white-space: pre-wrap; line-height: 1.45; color: #dbe6ff; margin-top: 10px; font-size: 13px; }
    .muted { color: var(--muted); }
    .hr { height:1px; background: rgba(35,52,87,.9); margin: 12px 0; }
    .small { font-size: 12px; color: var(--muted); }
    details summary { cursor:pointer; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title">
      <h1>å¨åŠ›å½©é¸è™Ÿå™¨ï¼ˆè¿‘ 5 å¹´é »ç‡/åˆ†å¸ƒ + åŠ æ¬Šè’™åœ°å¡ç¾… + è‡ªå‹•æŠ“æœ€æ–°ä¸€æœŸï¼‰</h1>
      <div class="sub">å†·è™Ÿå®šç¾©ï¼š<b>å‡ºç¾é »ç‡ä½</b>ï¼ˆAï¼‰ï½œç¬¬ä¸€å€ 1â€“38 æŠ½ 6ã€ä¸é‡è¤‡ï¼›ç¬¬äºŒå€ 1â€“8 æŠ½ 1</div>
    </div>
    <div class="row">
      <button id="btnLoadDemo">è¼‰å…¥å…§å»ºç¯„ä¾‹è³‡æ–™</button>
      <label class="pill">
        åŒ¯å…¥æ­·å² CSV
        <input id="csvFile" type="file" accept=".csv,text/csv" />
      </label>
      <button class="primary" id="btnFetchLatest">è‡ªå‹•æŠ“æœ€æ–°ä¸€æœŸä¸¦è¿½åŠ </button>
    </div>
  </div>

  <div class="kpi">
    <div class="pill">è³‡æ–™ç­†æ•¸ï¼š<span id="kpiRows" class="mono">0</span></div>
    <div class="pill">è³‡æ–™å€é–“ï¼š<span id="kpiRange" class="mono">-</span></div>
    <div class="pill">æœ€æ–°æœŸåˆ¥ï¼š<span id="kpiLatest" class="mono">-</span></div>
    <div class="pill">æŠ“å–ä¾†æºï¼š<span class="mono">lotto.ctbcbank.com</span></div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>é »ç‡åœ–ï¼ˆè¿‘ 5 å¹´ / ä½ è¼‰å…¥çš„è³‡æ–™ç¯„åœï¼‰</h2>
      <div class="charts2">
        <div class="card" style="padding:10px;">
          <div class="muted small">ç¬¬ä¸€å€ 1â€“38 å‡ºç¾æ¬¡æ•¸</div>
          <canvas id="chartMain"></canvas>
        </div>
        <div class="card" style="padding:10px;">
          <div class="muted small">ç¬¬äºŒå€ 1â€“8 å‡ºç¾æ¬¡æ•¸</div>
          <canvas id="chartSecond"></canvas>
        </div>
      </div>

      <div class="hr"></div>

      <h2>æ™‚é–“åˆ†å¸ƒï¼ˆé¸ä¸€å€‹è™Ÿç¢¼çœ‹ã€Œæ¯æ¬¡å‡ºç¾çš„æ—¥æœŸã€ï¼‰</h2>
      <div class="row">
        <label>å€åŸŸ
          <select id="selZone">
            <option value="main">ç¬¬ä¸€å€ï¼ˆ1â€“38ï¼‰</option>
            <option value="second">ç¬¬äºŒå€ï¼ˆ1â€“8ï¼‰</option>
          </select>
        </label>
        <label>è™Ÿç¢¼
          <select id="selNumber"></select>
        </label>
      </div>
      <div class="card" style="padding:10px; margin-top:10px;">
        <div class="muted small">æ•£é»ï¼è©²è™Ÿç¢¼å‡ºç¾çš„æ¯ä¸€æœŸï¼ˆy è»¸å›ºå®š 1 åªæ˜¯æ–¹ä¾¿ç•«ï¼‰</div>
        <canvas id="chartTimeline"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>åŠ æ¬Šé¸è™Ÿï¼ˆè’™åœ°å¡ç¾…æŠ½æ¨£å™¨ï¼‰</h2>

      <div class="row" style="margin-bottom:10px;">
        <label>æ¬Šé‡æ¨¡å¼
          <select id="selMode">
            <option value="hot">ç†±è™ŸåŠ æ¬Šï¼ˆé »ç‡é«˜ â†’ æ¬Šé‡é«˜ï¼‰</option>
            <option value="cold">å†·è™ŸåŠ æ¬Šï¼ˆé »ç‡ä½ â†’ æ¬Šé‡é«˜ï¼‰</option>
            <option value="mix">æ··åˆï¼ˆå‡å‹» + ç†±/å†·ï¼Œå¯èª¿ Î±ï¼‰</option>
          </select>
        </label>

        <label id="mixBaseWrap" style="display:none;">æ··åˆåŸºåº•
          <select id="selMixBase">
            <option value="hot">ç†±è™Ÿ</option>
            <option value="cold">å†·è™Ÿï¼ˆä½é »ï¼‰</option>
          </select>
        </label>

        <label id="alphaWrap" style="display:none;">Î±ï¼ˆè¶Šå¤§è¶Šæ¥è¿‘å‡å‹»ï¼‰
          <input id="rngAlpha" type="range" min="0" max="1" step="0.01" value="0.35" />
          <span id="alphaVal" class="mono">0.35</span>
        </label>
      </div>

      <div class="row">
        <label>ç”¢ç”Ÿçµ„æ•¸
          <input id="inpN" type="number" min="1" max="50" value="5" style="width:90px;" />
        </label>
        <button class="primary" id="btnGen">ç”¢ç”Ÿè™Ÿç¢¼</button>
      </div>

      <div class="hr"></div>

      <div class="muted small">æœ¬æ¬¡ç”¢ç”Ÿï¼ˆç¬¬ä¸€å€æ’åºé¡¯ç¤ºï¼‰ï¼š</div>
      <div id="preview" class="numbers"></div>
      <div id="out" class="out"></div>

      <div class="hr"></div>

      <h2>è¿‘ 5 å¹´ ç†±/å†·è™Ÿ Top 10ï¼ˆç¬¬ä¸€å€ï¼‰</h2>
      <div id="top10Main" class="out"></div>

      <h2 style="margin-top:10px;">è·é›¢ä¸Šæ¬¡é–‹å‡ºï¼ˆgapï¼ŒæœŸæ•¸ï¼‰</h2>
      <div class="small muted">gapï¼å¾æœ€æ–°ä¸€æœŸå¾€å›æ•¸ï¼Œ0 ä»£è¡¨æœ€æ–°ä¸€æœŸå°±å‡ºç¾</div>
      <div id="gapMain" class="out"></div>

      <div class="hr"></div>

      <details open>
        <summary class="small">Proxy è¨­å®šï¼ˆå»ºè­°ï¼šGAS Proxyï¼‰</summary>
        <div class="small" style="margin-top:8px;">
          æœ¬æ©Ÿç›´æ¥é–‹ HTMLï¼ˆfile://ï¼‰æŠ“ https ç¶²ç«™å¸¸è¢«ç€è¦½å™¨ CORS æ“‹ï¼›å› æ­¤å»ºè­°ç”¨ä½ è‡ªå·±çš„ GAS Proxyã€‚
        </div>

        <div class="row" style="margin-top:10px;">
          <label><input type="checkbox" id="chkUseProxy" checked /> ä½¿ç”¨ Proxy æŠ“å–æœ€æ–°ä¸€æœŸ</label>
        </div>

        <div class="small muted" style="margin-top:10px;">
          ä½ çš„ GAS Web App URLï¼ˆè«‹åœ¨ç¨‹å¼ç¢¼æœ€ä¸Šæ–¹çš„ <span class="mono">GAS_PROXY_BASE</span> ç½®æ›ï¼‰ï¼š<br/>
          <span class="mono" id="proxyUrlTxt"></span>
        </div>

        <div class="small muted" style="margin-top:8px;">
          æ¸¬è©¦ Proxyï¼šåœ¨ç€è¦½å™¨æ‰“é–‹ï¼š<br/>
          <span class="mono" id="proxyTestUrl"></span>
        </div>

        <div class="small muted" style="margin-top:10px;">
          ç«™å…§é è¨­è³‡æ–™ï¼š<span class="mono" id="defaultCsvTxt"></span>
        </div>
      </details>
    </div>
  </div>
</div>

<script>
/** =========================
 *  ä½ åªéœ€è¦æ”¹é€™å…©è¡Œï¼ˆè‹¥ä½ æª”åä¸åŒä¹Ÿæ”¹ï¼‰
 *  ========================= */
const GAS_PROXY_BASE = "https://script.google.com/macros/s/AKfycbwh0gqPHGeLa_QMA8CPch4aC4nixrceRVo9CDEcss_y9wN4KdIhIKriG1AltB7OcOAq/exec";
const DEFAULT_CSV_URL = "./datawl_5y.csv"; // âœ… æŠŠ 5 å¹´ CSV ä¸Šå‚³åˆ° repoï¼ŒåŒå±¤æ”¾é€™å€‹æª”å

/** ========= Config ========= */
const MAIN_MAX = 38;
const SECOND_MAX = 8;
const LATEST_SOURCE_URL = "https://lotto.ctbcbank.com/result_all.htm";

/** ========= State ========= */
let rows = []; // {draw_id, draw_date(Date), n:[6], s}
let chartMain, chartSecond, chartTimeline;

/** ========= Utilities ========= */
function pad2(n){ return String(n).padStart(2,"0"); }
function toISODate(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
  return `${y}-${m}-${da}`;
}
function parseDateFlexible(s){
  const t = (s||"").trim();
  if (!t) return null;

  let m = t.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
  if (m) return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));

  m = t.match(/(\d{2,3})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
  if (m){
    const roc = Number(m[1]);
    const y = roc + 1911;
    return new Date(y, Number(m[2])-1, Number(m[3]));
  }

  const d = new Date(t);
  return isNaN(d.getTime()) ? null : d;
}

/** é€šç”¨ CSV splitï¼ˆé€—è™Ÿ/TAB/åˆ†è™Ÿçš„é‚è¼¯åœ¨ csvParse å…§è™•ç†ï¼‰*/
function splitByDelim(line, delim){
  const res = [];
  let cur = "", inQ = false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"'){
      if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if (!inQ && ch === delim){
      res.push(cur); cur = "";
    } else {
      cur += ch;
    }
  }
  res.push(cur);
  return res;
}

function csvParse(text){
  const raw = text.replace(/\r/g,"");
  const lines = raw.split("\n").filter(l => l.trim().length);
  if (!lines.length) return [];

  const clean = (s)=>String(s ?? "")
    .replace(/^\uFEFF/,"")
    .replace(/\u3000/g," ")
    .trim();

  // è‡ªå‹•åµæ¸¬åˆ†éš”ç¬¦ï¼š, / \t / ;
  const headLine = lines[0];
  const cComma = (headLine.match(/,/g) || []).length;
  const cTab   = (headLine.match(/\t/g) || []).length;
  const cSemi  = (headLine.match(/;/g) || []).length;
  const delim = (cTab > cComma && cTab > cSemi) ? "\t" : (cSemi > cComma ? ";" : ",");

  const normKey = (k)=>clean(k).toLowerCase().replace(/\s+/g,"").replace(/[_\-\/]/g,"");

  const headerRaw = splitByDelim(lines[0], delim).map(clean);
  const headerN   = headerRaw.map(normKey);

  function findIdxByNames(...names){
    for (const nm of names){
      const t = normKey(nm);
      let i = headerN.indexOf(t);
      if (i !== -1) return i;
      i = headerRaw.findIndex(h => clean(h) === nm);
      if (i !== -1) return i;
    }
    return -1;
  }

  const idx = {
    game:      findIdxByNames("éŠæˆ²åç¨±","éŠæˆ²"),
    draw_id:   findIdxByNames("æœŸåˆ¥","æœŸè™Ÿ","æœŸæ•¸"),
    draw_date: findIdxByNames("é–‹çæ—¥æœŸ","æ—¥æœŸ"),
    n1:        findIdxByNames("çè™Ÿ1","çè™Ÿ 1","è™Ÿç¢¼1","è™Ÿç¢¼ 1"),
    n2:        findIdxByNames("çè™Ÿ2","çè™Ÿ 2","è™Ÿç¢¼2","è™Ÿç¢¼ 2"),
    n3:        findIdxByNames("çè™Ÿ3","çè™Ÿ 3","è™Ÿç¢¼3","è™Ÿç¢¼ 3"),
    n4:        findIdxByNames("çè™Ÿ4","çè™Ÿ 4","è™Ÿç¢¼4","è™Ÿç¢¼ 4"),
    n5:        findIdxByNames("çè™Ÿ5","çè™Ÿ 5","è™Ÿç¢¼5","è™Ÿç¢¼ 5"),
    n6:        findIdxByNames("çè™Ÿ6","çè™Ÿ 6","è™Ÿç¢¼6","è™Ÿç¢¼ 6"),
    s:         findIdxByNames("ç¬¬äºŒå€","ç¬¬2å€","ç‰¹åˆ¥è™Ÿ"),
  };

  const need = ["draw_id","draw_date","n1","n2","n3","n4","n5","n6","s"];
  const missing = need.filter(k => idx[k] === -1);
  if (missing.length){
    throw new Error(
      `CSV æ¬„ä½è¾¨è­˜ä¸åˆ°ï¼š${missing.join(", ")}ã€‚\n` +
      `åµæ¸¬åˆ°åˆ†éš”ç¬¦ï¼š${delim === "\t" ? "TAB(\\t)" : delim}\n` +
      `ç¬¬ä¸€åˆ—æ¬„åè§£æçµæœï¼š${headerRaw.join(" | ")}`
    );
  }

  const toNum = (v)=>{
    const s = clean(v).replace(/[^\d]/g,"");
    if (!s) return NaN;
    return Number(s);
  };

  const out = [];
  for (let i=1;i<lines.length;i++){
    const cols = splitByDelim(lines[i], delim);

    if (idx.game !== -1){
      const g = clean(cols[idx.game]);
      if (g && g !== "å¨åŠ›å½©") continue;
    }

    const draw_id = clean(cols[idx.draw_id]);
    const dStr = clean(cols[idx.draw_date]);
    const d = parseDateFlexible(dStr);

    const n = [idx.n1,idx.n2,idx.n3,idx.n4,idx.n5,idx.n6].map(k=>toNum(cols[k]));
    const s = toNum(cols[idx.s]);

    if (!draw_id || !d || n.some(x=>!Number.isFinite(x)) || !Number.isFinite(s)) continue;
    if (n.some(x=>x<1 || x>MAIN_MAX) || s<1 || s>SECOND_MAX) continue;

    out.push({ draw_id, draw_date: d, n, s });
  }

  return out;
}

function uniqByDrawId(arr){
  const m = new Map();
  for (const r of arr){
    if (!m.has(r.draw_id)) m.set(r.draw_id, r);
  }
  return Array.from(m.values()).sort((a,b)=>a.draw_date-b.draw_date);
}

function lastNYears(arr, years=5){
  if (!arr.length) return [];
  const maxDate = arr[arr.length-1].draw_date;
  const start = new Date(maxDate);
  start.setFullYear(start.getFullYear() - years);
  return arr.filter(r=>r.draw_date >= start);
}

/** ========= Stats ========= */
function freqMain(data){
  const f = Array(MAIN_MAX+1).fill(0);
  for (const r of data) for (const x of r.n) f[x]++;
  return f;
}
function freqSecond(data){
  const f = Array(SECOND_MAX+1).fill(0);
  for (const r of data) f[r.s]++;
  return f;
}

function topKFromFreq(freqArr, k=10, mode="hot"){
  const items = [];
  for (let i=1;i<freqArr.length;i++){
    items.push({num:i, cnt: freqArr[i]});
  }
  items.sort((a,b)=>{
    if (mode==="hot"){
      if (b.cnt !== a.cnt) return b.cnt - a.cnt;
      return a.num - b.num;
    } else {
      if (a.cnt !== b.cnt) return a.cnt - b.cnt;
      return a.num - b.num;
    }
  });
  return items.slice(0,k);
}

function calcGapMain(data){
  const gap = Array(MAIN_MAX+1).fill(null);
  for (let back=0; back<data.length; back++){
    const r = data[data.length-1-back];
    for (const x of r.n){
      if (gap[x] === null) gap[x] = back;
    }
    let done = true;
    for (let i=1;i<=MAIN_MAX;i++){ if (gap[i] === null) { done=false; break; } }
    if (done) break;
  }
  return gap;
}

function renderTopAndGap(){
  if (!rows.length) return;

  const data5 = lastNYears(rows, 5);
  const fm = freqMain(data5);

  const hot10 = topKFromFreq(fm, 10, "hot");
  const cold10 = topKFromFreq(fm, 10, "cold");

  const fmtList = (arr)=>arr.map((x,i)=>`${String(i+1).padStart(2,"0")}. ${pad2(x.num)}ï¼ˆ${x.cnt}ï¼‰`).join("\n");

  const elTop = document.getElementById("top10Main");
  if (elTop){
    elTop.textContent =
      `ğŸ”¥ ç†±è™Ÿ Top10ï¼ˆæ¬¡æ•¸ï¼‰\n${fmtList(hot10)}\n\n` +
      `ğŸ§Š å†·è™Ÿ Top10ï¼ˆæ¬¡æ•¸ï¼‰\n${fmtList(cold10)}`;
  }

  const gap = calcGapMain(data5);
  const gapItems = [];
  for (let i=1;i<=MAIN_MAX;i++) gapItems.push({num:i, gap: gap[i]});

  gapItems.sort((a,b)=>{
    const ga = (a.gap===null)? 1e9 : a.gap;
    const gb = (b.gap===null)? 1e9 : b.gap;
    if (gb !== ga) return gb - ga;
    return a.num - b.num;
  });

  const topGap = gapItems.slice(0, 15);
  const elGap = document.getElementById("gapMain");
  if (elGap){
    elGap.textContent =
      `â³ æœ€ä¹…æ²’å‡ºçš„å‰ 15ï¼ˆgap æœŸæ•¸ï¼‰\n` +
      topGap.map((x,i)=>{
        const g = (x.gap===null) ? "NA" : String(x.gap);
        return `${String(i+1).padStart(2,"0")}. ${pad2(x.num)}ï¼ˆgap=${g}ï¼‰`;
      }).join("\n");
  }
}

/** ========= Weighted sampling without replacement ========= */
function weightedSampleWithoutReplacement(items, weights, k){
  const scored = items.map((it,i)=>{
    const w = Math.max(1e-9, weights[i]);
    const u = Math.random();
    const key = Math.pow(u, 1.0 / w);
    return {it, key};
  });
  scored.sort((a,b)=>b.key-a.key);
  return scored.slice(0,k).map(x=>x.it);
}

function buildWeights(mode, base, alpha, data){
  const fm = freqMain(data);
  const fs = freqSecond(data);

  const mainCount = fm.slice(1);
  const secCount  = fs.slice(1);

  const maxM = Math.max(...mainCount, 1);
  const maxS = Math.max(...secCount, 1);

  function hotW(counts){ return counts.map(c=>c); }
  function coldW(counts, maxC){ return counts.map(c=> (maxC - c + 1)); }

  let wm, ws;

  if (mode === "hot"){
    wm = hotW(mainCount); ws = hotW(secCount);
  } else if (mode === "cold"){
    wm = coldW(mainCount, maxM); ws = coldW(secCount, maxS);
  } else {
    const uniM = Array(MAIN_MAX).fill(1);
    const uniS = Array(SECOND_MAX).fill(1);
    const baseWm = (base==="cold") ? coldW(mainCount, maxM) : hotW(mainCount);
    const baseWs = (base==="cold") ? coldW(secCount, maxS) : hotW(secCount);

    wm = uniM.map((u,i)=> alpha*u + (1-alpha)*baseWm[i]);
    ws = uniS.map((u,i)=> alpha*u + (1-alpha)*baseWs[i]);
  }

  return {
    wm: wm.map(x=>Math.max(1e-6,x)),
    ws: ws.map(x=>Math.max(1e-6,x))
  };
}

/** ========= UI / Charts ========= */
function setKPI(){
  document.getElementById("kpiRows").textContent = rows.length;
  if (!rows.length){
    document.getElementById("kpiRange").textContent = "-";
    document.getElementById("kpiLatest").textContent = "-";
    return;
  }
  const minD = rows[0].draw_date, maxD = rows[rows.length-1].draw_date;
  document.getElementById("kpiRange").textContent = `${toISODate(minD)} ~ ${toISODate(maxD)}`;
  document.getElementById("kpiLatest").textContent = rows[rows.length-1].draw_id;
}

function rebuildNumberOptions(){
  const zone = document.getElementById("selZone").value;
  const sel = document.getElementById("selNumber");
  sel.innerHTML = "";
  const max = (zone==="main") ? MAIN_MAX : SECOND_MAX;
  for (let i=1;i<=max;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    sel.appendChild(opt);
  }
}

function renderTimeline(){
  if (!rows.length) return;
  const data5 = lastNYears(rows, 5);
  const zone = document.getElementById("selZone").value;
  const num = Number(document.getElementById("selNumber").value);

  const pts = [];
  for (const r of data5){
    const hit = (zone==="main") ? r.n.includes(num) : (r.s === num);
    if (hit) pts.push({ x: r.draw_date.getTime(), y: 1, draw_id: r.draw_id });
  }

  const ctxT = document.getElementById("chartTimeline");
  if (chartTimeline) chartTimeline.destroy();

  chartTimeline = new Chart(ctxT, {
    type: 'scatter',
    data: { datasets: [{ label:"å‡ºç¾", data: pts, pointRadius: 4 }] },
    options: {
      responsive:true,
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const d = new Date(ctx.raw.x);
              return `${toISODate(d)} æœŸåˆ¥ ${ctx.raw.draw_id}`;
            }
          }
        }
      },
      scales:{
        x:{ type:'time', time:{ unit:'month' }, ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } },
        y:{ min:0, max:2, ticks:{ display:false }, grid:{ color:"rgba(35,52,87,.15)" } }
      }
    }
  });
}

function renderCharts(){
  if (!rows.length) return;
  const data5 = lastNYears(rows, 5);

  const fm = freqMain(data5);
  const fs = freqSecond(data5);

  const labelsM = Array.from({length:MAIN_MAX}, (_,i)=>String(i+1));
  const valuesM = fm.slice(1);
  const labelsS = Array.from({length:SECOND_MAX}, (_,i)=>String(i+1));
  const valuesS = fs.slice(1);

  const ctxM = document.getElementById("chartMain");
  const ctxS = document.getElementById("chartSecond");

  if (chartMain) chartMain.destroy();
  if (chartSecond) chartSecond.destroy();

  chartMain = new Chart(ctxM, {
    type: 'bar',
    data: { labels: labelsM, datasets: [{ label:"æ¬¡æ•¸", data: valuesM }] },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ enabled:true } },
      scales:{
        x:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } },
        y:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } }
      }
    }
  });

  chartSecond = new Chart(ctxS, {
    type: 'bar',
    data: { labels: labelsS, datasets: [{ label:"æ¬¡æ•¸", data: valuesS }] },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false }, tooltip:{ enabled:true } },
      scales:{
        x:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } },
        y:{ ticks:{ color:"#9fb0d0" }, grid:{ color:"rgba(35,52,87,.35)" } }
      }
    }
  });

  rebuildNumberOptions();
  renderTimeline();
  renderTopAndGap();
}

/** ========= Generator ========= */
function genOne(mode, mixBase, alpha, data5){
  const {wm, ws} = buildWeights(mode, mixBase, alpha, data5);

  const mainItems = Array.from({length:MAIN_MAX}, (_,i)=>i+1);
  const secItems  = Array.from({length:SECOND_MAX}, (_,i)=>i+1);

  const pickedMain = weightedSampleWithoutReplacement(mainItems, wm, 6).sort((a,b)=>a-b);
  const pickedSec  = weightedSampleWithoutReplacement(secItems, ws, 1)[0];

  return { pickedMain, pickedSec };
}

function renderPreview(main, sec){
  const box = document.getElementById("preview");
  box.innerHTML = "";
  for (const x of main){
    const d = document.createElement("div");
    d.className = "ball";
    d.textContent = pad2(x);
    box.appendChild(d);
  }
  const s = document.createElement("div");
  s.className = "ball s";
  s.textContent = pad2(sec);
  box.appendChild(s);
}

/** ========= Latest fetch + append (via GAS Proxy) ========= */
function gasProxyUrl(targetUrl){
  if (!GAS_PROXY_BASE){
    throw new Error("ä½ é‚„æ²’è¨­å®š GAS_PROXY_BASEï¼ˆè«‹æŠŠå®ƒæ›æˆä½ çš„ GAS Web App URLï¼‰");
  }
  const joiner = GAS_PROXY_BASE.includes("?") ? "&" : "?";
  return `${GAS_PROXY_BASE}${joiner}url=${encodeURIComponent(targetUrl)}`;
}
async function gasCall(action){
  const joiner = GAS_PROXY_BASE.includes("?") ? "&" : "?";
  const url = `${GAS_PROXY_BASE}${joiner}action=${encodeURIComponent(action)}`;
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`GAS å‘¼å«å¤±æ•—ï¼šHTTP ${res.status}`);
  const j = await res.json();
  if (!j.ok) throw new Error(j.error || "GAS å›å‚³å¤±æ•—");
  return j;
}

  
async function fetchText(targetUrl){
  const useProxy = document.getElementById("chkUseProxy").checked;
  const finalUrl = useProxy ? gasProxyUrl(targetUrl) : targetUrl;

  const res = await fetch(finalUrl, { cache: "no-store" });
  if (!res.ok) throw new Error(`æŠ“å–å¤±æ•—ï¼šHTTP ${res.status}`);

  // Proxy å› JSONï¼›é Proxy å› HTML
  if (useProxy){
    const j = await res.json();
    if (!j.ok) throw new Error(j.error || "Proxy å›å‚³å¤±æ•—");
    return j.body;
  }
  return await res.text();
}

function parseLatestFromCTBC(html){
  const text = html
    .replace(/<script[\s\S]*?<\/script>/gi, " ")
    .replace(/<style[\s\S]*?<\/style>/gi, " ")
    .replace(/<br\s*\/?>/gi, "\n")
    .replace(/<\/(p|div|tr|li|h\d)>/gi, "\n")
    .replace(/<[^>]+>/g, " ")
    .replace(/&nbsp;|&#160;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/\s+/g, " ")
    .replace(/\s*\n\s*/g, "\n")
    .trim();

  const idx = text.indexOf("å¨åŠ›å½©");
  if (idx === -1) throw new Error("æ‰¾ä¸åˆ°ã€å¨åŠ›å½©ã€å€å¡Šï¼ˆä¾†æºç‰ˆé¢å¯èƒ½æ”¹äº†ï¼‰");
  const slice = text.slice(idx, idx + 8000);

  const idMatch =
    slice.match(/ç¬¬\s*([0-9]{6,})\s*æœŸ/) ||
    slice.match(/æœŸ\s*åˆ¥[\s:ï¼š]*ç¬¬?\s*([0-9]{6,})\s*æœŸ?/);
  if (!idMatch) throw new Error("è§£æå¤±æ•—ï¼šæ‰¾ä¸åˆ°æœŸåˆ¥");
  const draw_id = idMatch[1].trim();

  const dateMatch =
    slice.match(/é–‹çæ—¥æœŸ[\s:ï¼š]*([^\n]{0,60})/) ||
    slice.match(/é–‹çæ—¥[\s:ï¼š]*([^\n]{0,60})/);
  if (!dateMatch) throw new Error("è§£æå¤±æ•—ï¼šæ‰¾ä¸åˆ°é–‹çæ—¥æœŸ");
  const draw_date = parseDateFlexible(dateMatch[1]);
  if (!draw_date) throw new Error("è§£æå¤±æ•—ï¼šé–‹çæ—¥æœŸæ ¼å¼ä¸æ˜");

  let mainArea = slice;
  const m1 = slice.match(/ç¬¬\s*1\s*å€[\s\S]{0,800}/);
  if (m1) mainArea = m1[0];

  const mainNums = (mainArea.match(/\b([0-9]{1,2})\b/g) || [])
    .map(Number)
    .filter(n => n >= 1 && n <= 38);

  let n = null;
  for (let i=0; i<=mainNums.length-6; i++){
    const cand = mainNums.slice(i, i+6);
    if (new Set(cand).size === 6) { n = cand; break; }
  }
  if (!n) throw new Error("è§£æå¤±æ•—ï¼šæ‰¾ä¸åˆ°ç¬¬ä¸€å€ 6 ç¢¼");

  let secArea = slice;
  const s1 = slice.match(/ç¬¬\s*2\s*å€[\s\S]{0,200}/);
  if (s1) secArea = s1[0];

  const secNums = (secArea.match(/\b([0-9]{1,2})\b/g) || [])
    .map(Number)
    .filter(x => x >= 1 && x <= 8);

  if (!secNums.length) throw new Error("è§£æå¤±æ•—ï¼šæ‰¾ä¸åˆ°ç¬¬äºŒå€");
  const s = secNums[0];

  n = n.slice(0,6).sort((a,b)=>a-b);
  return { draw_id, draw_date, n, s };
}

async function appendLatest(){
  const btn = document.getElementById("btnFetchLatest");
  btn.disabled = true;
  btn.textContent = "å¯«å…¥ä¸­â€¦";

  try{
    // 1) å« GAS æŠ“æœ€æ–° + å¯«é€² Sheet
    const r1 = await gasCall("append_latest");

    // 2) å†æŠŠ Sheet å…§ã€Œå®Œæ•´è³‡æ–™ã€æ‹‰å›ä¾†æ›´æ–°å‰ç«¯ rows
    const r2 = await gasCall("export");

    // GAS export å‡ºä¾†çš„æ¬„ä½æ˜¯ draw_id, draw_date(yyyy-mm-dd), n1..n6, s
    rows = r2.data.map(x => ({
      draw_id: String(x.draw_id),
      draw_date: parseDateFlexible(String(x.draw_date)),
      n: [x.n1,x.n2,x.n3,x.n4,x.n5,x.n6].map(Number),
      s: Number(x.s)
    }));

    rows = uniqByDrawId(rows);
    setKPI();
    renderCharts();

    if (r1.inserted){
      alert(`å·²å¯«å…¥ä¸¦æ›´æ–°ï¼š${r1.latest.draw_id}\n${r1.latest.draw_date}\n${r1.latest.n.join(", ")} + ${pad2(r1.latest.s)}`);
    } else {
      alert(`ä½ çš„è³‡æ–™å·²åŒ…å«æœ€æ–°ä¸€æœŸï¼š${r1.latest.draw_id}\nï¼ˆå·²åŒæ­¥æœ€æ–°è³‡æ–™ï¼‰`);
    }

  } catch(e){
    console.error(e);
    alert(`æ›´æ–°å¤±æ•—ï¼š\n${e.message}\n\nè«‹ç¢ºèªï¼š\n1) GAS å·²éƒ¨ç½²ç‚º Web Appï¼ˆAnyoneï¼‰\n2) GAS_PROXY_BASE æ˜¯æœ€æ–° /exec\n3) GAS å·²æˆæ¬Š UrlFetch + Spreadsheet`);
  } finally {
    btn.disabled = false;
    btn.textContent = "è‡ªå‹•æŠ“æœ€æ–°ä¸€æœŸä¸¦è¿½åŠ ";
  }
}

/** ========= Demo data ========= */
function loadDemo(){
  const base = [
    ["115000010","2026-02-02",[1,12,14,15,27,29],5],
    ["115000011","2026-02-05",[7,22,28,34,36,37],7],
    ["115000012","2026-02-09",[13,14,16,33,34,37],2],
    ["114000150","2025-12-29",[1,3,9,11,18,32],6],
    ["114000151","2026-01-01",[7,14,22,23,31,35],1],
    ["114000152","2026-01-05",[11,14,19,25,34,37],4]
  ];
  rows = base.map(x=>({draw_id:x[0], draw_date:parseDateFlexible(x[1]), n:x[2], s:x[3]}));
  rows = uniqByDrawId(rows);
  setKPI();
  renderCharts();
}

/** ========= Load CSV from URL (for GitHub Pages) ========= */
async function loadCsvFromUrl(url){
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`è¼‰å…¥ç«™å…§ CSV å¤±æ•—ï¼šHTTP ${res.status}`);
  const text = await res.text();
  const parsed = csvParse(text);
  rows = uniqByDrawId(parsed);
  setKPI();
  renderCharts();
}

/** ========= Wire up ========= */
document.getElementById("btnLoadDemo").addEventListener("click", loadDemo);

document.getElementById("csvFile").addEventListener("change", async (ev)=>{
  const f = ev.target.files?.[0];
  if (!f) return;

  // é€™è£¡ä»ç”¨ text()ï¼Œè‹¥ä½ ä¹‹å¾Œåˆé‡åˆ° Big5ï¼Œå¯å†åŠ  smart decoder
  const text = await f.text();
  try{
    const parsed = csvParse(text);
    rows = uniqByDrawId(parsed);
    setKPI();
    renderCharts();
    alert(`åŒ¯å…¥å®Œæˆï¼š${rows.length} ç­†`);
  } catch(e){
    alert(`åŒ¯å…¥å¤±æ•—ï¼š${e.message}`);
  } finally {
    ev.target.value = "";
  }
});

document.getElementById("btnFetchLatest").addEventListener("click", appendLatest);

document.getElementById("selZone").addEventListener("change", ()=>{
  rebuildNumberOptions();
  renderTimeline();
});
document.getElementById("selNumber").addEventListener("change", renderTimeline);

document.getElementById("selMode").addEventListener("change", ()=>{
  const mode = document.getElementById("selMode").value;
  const showMix = (mode === "mix");
  document.getElementById("alphaWrap").style.display = showMix ? "" : "none";
  document.getElementById("mixBaseWrap").style.display = showMix ? "" : "none";
});

document.getElementById("rngAlpha").addEventListener("input", (e)=>{
  document.getElementById("alphaVal").textContent = Number(e.target.value).toFixed(2);
});

document.getElementById("btnGen").addEventListener("click", ()=>{
  if (!rows.length){
    alert("å°šæœªè¼‰å…¥è³‡æ–™ï¼šå¯åŒ¯å…¥ CSV æˆ–ç­‰å¾…ç«™å…§é è¨­è³‡æ–™è¼‰å…¥ã€‚");
    return;
  }
  const data5 = lastNYears(rows, 5);
  if (!data5.length){
    alert("è¿‘ 5 å¹´è³‡æ–™ç‚ºç©ºï¼ˆæˆ–æ—¥æœŸè§£æå¤±æ•—ï¼‰ã€‚è«‹ç¢ºèªè³‡æ–™æ—¥æœŸæ ¼å¼ã€‚");
    return;
  }

  const mode = document.getElementById("selMode").value;
  const mixBase = document.getElementById("selMixBase").value;
  const alpha = Number(document.getElementById("rngAlpha").value);
  const N = Math.max(1, Math.min(50, Number(document.getElementById("inpN").value || 5)));

  const lines = [];
  for (let i=0;i<N;i++){
    const {pickedMain, pickedSec} = genOne(mode, mixBase, alpha, data5);
    lines.push(`${String(i+1).padStart(2,"0")}. ${pickedMain.map(pad2).join(" ")}  +  ${pad2(pickedSec)}`);
    if (i===0) renderPreview(pickedMain, pickedSec);
  }
  document.getElementById("out").textContent = lines.join("\n");
});

// Boot (GitHub Pages: auto-load DEFAULT_CSV_URL; fallback to demo)
document.getElementById("alphaVal").textContent = Number(document.getElementById("rngAlpha").value).toFixed(2);

(async function boot(){
  // Show proxy text & test link
  (function initProxyInfo(){
    const proxyTxt = document.getElementById("proxyUrlTxt");
    const testTxt  = document.getElementById("proxyTestUrl");
    const example = "https://script.google.com/macros/s/XXXXX/exec";
    const base = (!GAS_PROXY_BASE) ? example : GAS_PROXY_BASE;
    proxyTxt.textContent = base;

    const joiner = base.includes("?") ? "&" : "?";
    const testUrl = `${base}${joiner}url=${encodeURIComponent(LATEST_SOURCE_URL)}`;
    testTxt.textContent = testUrl;

    const d = document.getElementById("defaultCsvTxt");
    if (d) d.textContent = DEFAULT_CSV_URL;
  })();

  try{
    await loadCsvFromUrl(DEFAULT_CSV_URL);
  } catch(e){
    console.error(e);
    // Bootï¼šå„ªå…ˆè®€ GAS Sheetï¼ˆåˆ†äº«çµ¦åˆ¥äººä¹Ÿä¸ç”¨åŒ¯å…¥ CSVï¼‰
(async function boot(){
  try{
    const r = await gasCall("export");
    rows = r.data.map(x => ({
      draw_id: String(x.draw_id),
      draw_date: parseDateFlexible(String(x.draw_date)),
      n: [x.n1,x.n2,x.n3,x.n4,x.n5,x.n6].map(Number),
      s: Number(x.s)
    }));
    rows = uniqByDrawId(rows);
    setKPI();
    renderCharts();
  } catch(e){
    console.warn("boot export failed, fallback to demo", e);
    loadDemo();
  }
})();
;
    alert("ç«™å…§ 5 å¹´è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå·²æ”¹ç”¨ç¯„ä¾‹è³‡æ–™ã€‚\n\n" + e.message + "\n\nè«‹ç¢ºèª repo åŒå±¤å­˜åœ¨ datawl_5y.csvï¼ˆUTF-8ï¼‰");
  }
})();
</script>
</body>
</html>



